Bootstrap: docker
From: ubuntu:18.04

%labels
    maintainer "Hugging Face"
    repository "transformers"

%environment
    export PATH=/usr/local/bin:$PATH
    export PYTHONUNBUFFERED=1

%setup
    # 创建工作目录
    mkdir -p ${APPTAINER_ROOTFS}/workspace/loralib
    mkdir -p ${APPTAINER_ROOTFS}/workspace/transformers

    # 复制主机上的 CLIP/loralib 到容器内
    cp -r ./LoRA/loralib/* ${APPTAINER_ROOTFS}/workspace/loralib/

    # 复制主机上的 CLIP/setup.py 到容器内
    cp ./LoRA/setup.py ${APPTAINER_ROOTFS}/workspace/setup.py

    # 复制主机上的 CLIP 目录下的所有 .md 文件到容器内
    cp ./LoRA/*.md ${APPTAINER_ROOTFS}/workspace/

    # 复制主机上的 CLIP/examples/NLU 到容器内的 transformers 目录
    cp -r ./LoRA/examples/NLU/* ${APPTAINER_ROOTFS}/workspace/transformers/

%post
    # 更新软件源并安装必要的包
    apt update && \
    apt install -y bash \
                   build-essential \
                   git \
                   curl \
                   vim \
                   cmake \
                   ca-certificates \
                   python3 \
                   python3-pip && \
    rm -rf /var/lib/apt/lists/*

    # 升级 pip 并安装 Python 包
    python3 -m pip install --no-cache-dir --upgrade pip && \
    python3 -m pip install --no-cache-dir \
        jupyter \
        packaging==20.9 \
        datasets==2.0.0 \
        sentencepiece==0.1.91 \
        black==20.8b1 \
        cookiecutter==1.7.2 \
        flake8==3.8.3 \
        flax==0.3.2 \
        fugashi==1.0 \
        importlib_metadata \
        ipadic==1.0.0 \
        isort==5.5.4 \
        jax==0.2.8 \
        unidic==1.0.2 \
        unidic_lite==1.0.7 \
        tokenizers==0.10.2

    # 安装指定版本的 PyTorch
    python3 -m pip install --no-cache-dir \
        torch==1.9.0+cu111 -f https://download.pytorch.org/whl/torch_stable.html

    # 设置工作目录
    cd /workspace

    # 安装当前目录下的包
    python3 -m pip install --no-cache-dir .

    # 进入 transformers 目录并安装
    cd transformers/
    python3 -m pip install --no-cache-dir .

%runscript
    exec /bin/bash "$@"