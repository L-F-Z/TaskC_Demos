Bootstrap: docker
From: 192.168.2.25:10081/ubuntu:18.04

%labels
    maintainer "Hugging Face"
    repository "transformers"

%environment
    export PATH=/usr/local/bin:$PATH
    export PYTHONUNBUFFERED=1

%setup
    # create workspace directory
    mkdir -p ${APPTAINER_ROOTFS}/workspace/loralib
    mkdir -p ${APPTAINER_ROOTFS}/workspace/transformers
    mkdir -p ${APPTAINER_ROOTFS}/.pip/

    cp ./resource/pip.conf ${APPTAINER_ROOTFS}/.pip/pip.conf
    cp -r ./LoRA/loralib/* ${APPTAINER_ROOTFS}/workspace/loralib/
    cp ./LoRA/setup.py ${APPTAINER_ROOTFS}/workspace/setup.py
    cp ./LoRA/*.md ${APPTAINER_ROOTFS}/workspace/
    cp -r ./LoRA/examples/NLU/* ${APPTAINER_ROOTFS}/workspace/transformers/

%post

    # Modify /etc/apt/sources.list to use PkgCache
    total_lines=$(wc -l < /etc/apt/sources.list) && lines_to_keep=$((total_lines - 6)) && head -n $lines_to_keep /etc/apt/sources.list > /etc/apt/sources.list.new
    sed -i 's|http://archive.ubuntu.com/ubuntu/|http://192.168.2.25:9081/repository/ubuntu/|g' /etc/apt/sources.list.new
    mv /etc/apt/sources.list.new /etc/apt/sources.list

    # apt install pkgs
    apt update && \
    apt install -y bash \
                   build-essential \
                   curl \
                   vim \
                   cmake \
                   ca-certificates \
                   python3 \
                   python3-pip && \
    rm -rf /var/lib/apt/lists/*

    # Modify ~/.pip/pip.conf to use PkgCache
    # mkdir ~/.pip/; test -f ~/.pip/pip.conf && mv ~/.pip/pip.conf ~/.pip/pip.conf.bak; curl -s -o ~/.pip/pip.conf -m 3 https://raw.githubusercontent.com/brandnewworld/staging/refs/heads/main/pip.conf

    python3 -m pip install --no-cache-dir --upgrade pip && \
    python3 -m pip install --no-cache-dir \
        jupyter \
        packaging==20.9 \
        datasets==2.0.0 \
        sentencepiece==0.1.91 \
        black==20.8b1 \
        cookiecutter==1.7.2 \
        flake8==3.8.3 \
        flax==0.3.2 \
        fugashi==1.0 \
        importlib_metadata \
        ipadic==1.0.0 \
        isort==5.5.4 \
        jax==0.2.8 \
        unidic==1.0.2 \
        unidic_lite==1.0.7 \
        tokenizers==0.10.2

    # Install torch
    python3 -m pip install --no-cache-dir \
        torch==1.9.0+cu111 -f https://download.pytorch.org/whl/torch_stable.html

    cd /workspace

    python3 -m pip install --no-cache-dir .

    cd transformers/
    python3 -m pip install --no-cache-dir .

%runscript
    exec /bin/bash "$@"