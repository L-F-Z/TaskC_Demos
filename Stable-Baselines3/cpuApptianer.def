Bootstrap: docker
From: mambaorg/micromamba:1.5-jammy

%environment
    export PYTORCH_DEPS=cpuonly
    export PYTHON_VERSION=3.10
    export MAMBA_DOCKERFILE_ACTIVATE=1
    export MAMBA_USER=micromamba
    export CODE_DIR=/home/$MAMBA_USER

%setup
    mkdir -p ${APPTAINER_ROOTFS}${CODE_DIR}/stable-baselines3/stable_baselines3
    mkdir -p ${APPTAINER_ROOTFS}${CODE_DIR}/stable-baselines3/tests

    cp -r ./stable_baselines3/* ${APPTAINER_ROOTFS}${CODE_DIR}/stable-baselines3/stable_baselines3/
    # cp ${PWD}/setup.py ${APPTAINER_ROOTFS}${CODE_DIR}/stable-baselines3/
    # cp -r ${PWD}/tests/* ${APPTAINER_ROOTFS}${CODE_DIR}/stable-baselines3/tests/
    cp ${PWD}/stable_baselines3/version.txt ${APPTAINER_ROOTFS}${CODE_DIR}/stable-baselines3/stable_baselines3/

%post
    export PYTORCH_DEPS=cpuonly
    export PYTHON_VERSION=3.10
    export MAMBA_DOCKERFILE_ACTIVATE=1
    export MAMBA_USER=micromamba
    export CODE_DIR=/home/$MAMBA_USER

    source /usr/local/bin/_activate_current_env.sh

    micromamba install -n base -y python=$PYTHON_VERSION \
        pytorch $PYTORCH_DEPS -c conda-forge -c pytorch -c nvidia && \
        micromamba clean --all --yes

    chown -R $MAMBA_USER:$MAMBA_USER $CODE_DIR/stable-baselines3

    cd $CODE_DIR/stable-baselines3 && \
        pip install -e .[extra,tests,docs] && \
        pip uninstall -y opencv-python && \
        pip install opencv-python-headless && \
        pip cache purge

%runscript
    exec /bin/bash "$@"