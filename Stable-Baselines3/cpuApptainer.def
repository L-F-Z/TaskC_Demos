Bootstrap: docker
From: 192.168.2.25:10081/mambaorg/micromamba:1.5-jammy

%setup
    # Create necessary directories
    mkdir -p ${APPTAINER_ROOTFS}/stable-baselines3/stable_baselines3
    mkdir -p ${APPTAINER_ROOTFS}/stable-baselines3/tests


    # Copy files to the container's filesystem
    cp -r ./stable-baselines3/stable_baselines3/* ${APPTAINER_ROOTFS}/stable-baselines3/stable_baselines3/
    cp ./stable-baselines3/setup.py ${APPTAINER_ROOTFS}/stable-baselines3/setup.py
    cp -r ./stable-baselines3/tests/* ${APPTAINER_ROOTFS}/stable-baselines3/tests/
    cp ./stable-baselines3/stable_baselines3/version.txt ${APPTAINER_ROOTFS}/stable-baselines3/stable_baselines3/version.txt

    mkdir -p ${APPTAINER_ROOTFS}/.conda/ && touch ${APPTAINER_ROOTFS}/.conda/.condarc
    cp ./resource/.condarc ${APPTAINER_ROOTFS}/.conda/.condarc

    mkdir -p ${APPTAINER_ROOTFS}/.pip/
    cp ./resource/pip.conf ${APPTAINER_ROOTFS}/.pip/pip.conf

%post
    export PYTORCH_DEPS=cpuonly
    export PYTHON_VERSION=3.10
    export MAMBA_DOCKERFILE_ACTIVATE=1
    export MAMBA_USER=micromamba

%post
    total_lines=$(wc -l < /etc/apt/sources.list) && lines_to_keep=$((total_lines - 6)) && head -n $lines_to_keep /etc/apt/sources.list > /etc/apt/sources.list.new
    sed -i 's|http://archive.ubuntu.com/ubuntu/|http://192.168.2.25:9081/repository/ubuntu/|g' /etc/apt/sources.list.new
    mv /etc/apt/sources.list.new /etc/apt/sources.list
    
    # Install system requirements
    apt-get update && apt-get install -y --no-install-recommends curl
    
    # Modify ~/.conda/.condarc to use PkgCache
    # mkdir -p ~/.conda/ && touch ~/.conda/.condarc
    # test -f ~/.conda/.condarc && \
    # mv ~/.conda/.condarc ~/.conda/.condarc.bak; curl -s -o ~/.conda/.condarc -m 3 http://192.168.2.25:4000/root/staging/raw/branch/main/.condarc

    # mkdir -p ~/.pip/ && touch ~/.pip/pip.conf
    # test -f ~/.pip/pip.conf && \
    # mv ~/.pip/pip.conf ~/.pip/pip.conf.bak; curl -s -o ~/.pip/pip.conf -m 3 http://192.168.2.25:4000/root/staging/raw/branch/main/pip.conf

    # Update and install micromamba dependencies
    micromamba install -n base -y python=${PYTHON_VERSION} \
        pytorch ${PYTORCH_DEPS} -c conda-forge -c pytorch -c nvidia && \
        micromamba clean --all --yes

    # Install pip dependencies
    micromamba run -n base bash -c "  
        cd ${APPTAINER_ROOTFS}/stable-baselines3 && \
        pip install -e .[extra,tests,docs] && \
        pip uninstall -y opencv-python && \
        pip install opencv-python-headless && \
        pip cache purge  
    " 

%runscript
    exec /bin/bash
