Bootstrap: docker
From: 192.168.2.25:10081/mambaorg/micromamba:1.5-jammy-cuda-11.7.1

%setup
    # Create necessary directories
    mkdir -p ${APPTAINER_ROOTFS}/stable-baselines3/stable_baselines3
    mkdir -p ${APPTAINER_ROOTFS}/stable-baselines3/tests

    # Copy files to the container's filesystem
    cp -r ./stable-baselines3/stable_baselines3/* ${APPTAINER_ROOTFS}/stable-baselines3/stable_baselines3/
    cp ./stable-baselines3/setup.py ${APPTAINER_ROOTFS}/stable-baselines3/setup.py
    cp -r ./stable-baselines3/tests/* ${APPTAINER_ROOTFS}/stable-baselines3/tests/
    cp ./stable-baselines3/stable_baselines3/version.txt ${APPTAINER_ROOTFS}/stable-baselines3/stable_baselines3/version.txt

    mkdir -p ${APPTAINER_ROOTFS}/.conda/ && touch ${APPTAINER_ROOTFS}/.conda/.condarc
    cp ./resource/.condarc ${APPTAINER_ROOTFS}/.conda/.condarc
    mkdir -p ${APPTAINER_ROOTFS}/.pip/
    cp ./resource/pip.conf ${APPTAINER_ROOTFS}/.pip/pip.conf
    
%post
    export PYTORCH_DEPS="pytorch-cuda=11.7"
    export PYTHON_VERSION=3.10
    export MAMBA_DOCKERFILE_ACTIVATE=1
    export MAMBA_USER=micromamba

%post    
    # # Modify ~/.conda/.condarc to use PkgCache
    # test -f ${APPTAINER_ROOTFS}/.conda/.condarc && \
    # mv ${APPTAINER_ROOTFS}/.conda/.condarc ${APPTAINER_ROOTFS}/.conda/.condarc.bak; curl -s -o ${APPTAINER_ROOTFS}/.conda/.condarc -m 3 https://raw.githubusercontent.com/brandnewworld/staging/refs/heads/main/.condarc

    # test -f ${APPTAINER_ROOTFS}/.pip/pip.conf && \
    # mv ${APPTAINER_ROOTFS}/.pip/pip.conf ${APPTAINER_ROOTFS}/.pip/pip.conf.bak; curl -s -o ${APPTAINER_ROOTFS}/.pip/pip.conf -m 3 http://192.168.2.25:4000/root/staging/raw/branch/main/pip.conf

    # Update and install micromamba dependencies
    micromamba install -n base -y python=${PYTHON_VERSION} \
        pytorch ${PYTORCH_DEPS} -c conda-forge -c pytorch -c nvidia && \
        micromamba clean --all --yes

    # Install pip dependencies
    micromamba run -n base bash -c "  
        cd ${APPTAINER_ROOTFS}/stable-baselines3 && \
        pip install -e .[extra,tests,docs] && \
        pip uninstall -y opencv-python && \
        pip install opencv-python-headless && \
        pip cache purge  
    " 

%runscript
    exec /bin/bash
