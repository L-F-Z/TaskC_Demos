Bootstrap: docker  
From: 192.168.143.41:10081/pytorch/pytorch:1.12.1-cuda11.3-cudnn8-devel

%setup  
    mkdir -p ${APPTAINER_ROOTFS}/app/stablediffusion

    cp -r stablediffusion ${APPTAINER_ROOTFS}/app/  
    cp ./resource/environment.yaml ${APPTAINER_ROOTFS}/app/stablediffusion/
    cp ./resource/txt2img.py ${APPTAINER_ROOTFS}/app/scripts/txt2img.py
    cp ./resource/v2-inference-v.yaml ${APPTAINER_ROOTFS}/app/stablediffusion/configs/stable-diffusion/v2-inference-v.yaml
    
    mkdir -p ${APPTAINER_ROOTFS}/.conda/ && touch ${APPTAINER_ROOTFS}/.conda/.condarc
    cp ./resource/.condarc ${APPTAINER_ROOTFS}/.conda/.condarc


%post  
    total_lines=$(wc -l < /etc/apt/sources.list) && lines_to_keep=$((total_lines - 6)) && head -n $lines_to_keep /etc/apt/sources.list > /etc/apt/sources.list.new
    sed -i 's|http://archive.ubuntu.com/ubuntu/|http://192.168.143.41:9081/repository/ubuntu/|g' /etc/apt/sources.list.new
    mv /etc/apt/sources.list.new /etc/apt/sources.list

    apt update && apt install --yes ffmpeg libsm6 libxext6 curl

    cd /app/stablediffusion/ 
    # curl -o /app/stablediffusion/v2-1_768-ema-pruned.ckpt http://192.168.143.41:9081/repository/storage/v2-1_768-ema-pruned.ckpt

    # Modify ~/.conda/.condarc to use PkgCache
    # mkdir ~/.conda/ && \
    # touch ~/.conda/.condarc && \
    # test -f ~/.conda/.condarc && \
    # mv ~/.conda/.condarc ~/.conda/.condarc.bak; curl -s -o ~/.conda/.condarc -m 3 http://192.168.143.41:4000/root/staging/raw/branch/main/.condarc

    conda config --add channels defaults  
    conda config --set show_channel_urls true
    conda info
    # conda config --add default_channels https://mirrors.ustc.edu.cn/anaconda/pkgs/main  
    # conda config --add default_channels https://mirrors.ustc.edu.cn/anaconda/pkgs/r  
    # conda config --add default_channels https://mirrors.ustc.edu.cn/anaconda/pkgs/msys2  
    # conda config --add custom_channels.conda-forge https://mirrors.ustc.edu.cn/anaconda/cloud  
    # conda config --add custom_channels.pytorch https://mirrors.ustc.edu.cn/anaconda/cloud  

    # conda update -n base -c defaults conda -y  
    conda env create -f environment.yaml  

    conda init bash  
    echo "conda activate ldm" >> ${APPTAINER_ROOTFS}/.bashrc  

%runscript  
    exec conda run -n ldm python scripts/txt2img.py "\$@"  