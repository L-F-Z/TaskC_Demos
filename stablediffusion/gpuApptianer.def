Bootstrap: docker
From: pytorch/pytorch:1.12.1-cuda11.3-cudnn8-devel

%setup
    # 将必要的文件复制到容器中
    mkdir -p ${APPTAINER_ROOTFS}/workspace/stablediffusion
    cp -r stablediffusion ${APPTAINER_ROOTFS}/workspace/
    cp environment.yaml v2-1_768-ema-pruned.ckpt ${APPTAINER_ROOTFS}/workspace/stablediffusion/

%post
    # 更新并安装必要的软件包
    apt update && apt install --yes ffmpeg libsm6 libxext6

    # 设置工作目录
    cd /workspace/stablediffusion/

    # 配置conda
    conda config --add channels defaults
    conda config --set show_channel_urls true
    conda config --add default_channels https://mirrors.ustc.edu.cn/anaconda/pkgs/main
    conda config --add default_channels https://mirrors.ustc.edu.cn/anaconda/pkgs/r
    conda config --add default_channels https://mirrors.ustc.edu.cn/anaconda/pkgs/msys2
    # conda config --add custom_channels.conda-forge https://mirrors.ustc.edu.cn/anaconda/cloud
    # conda config --add custom_channels.pytorch https://mirrors.ustc.edu.cn/anaconda/cloud

    # 创建conda环境
    conda env create -f environment.yaml

    # 初始化conda并配置bashrc
    conda init bash
    echo "conda activate ldm" >> ${APPTAINER_ROOTFS}/.bashrc

%environment
    # 设置必要的环境变量
    export PATH=/opt/conda/envs/ldm/bin:$PATH

%runscript
    # 运行入口
    exec conda run -n ldm python scripts/txt2img.py "$@"