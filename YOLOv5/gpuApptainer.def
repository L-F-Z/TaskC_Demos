

Bootstrap: docker
From: 192.168.2.25:10081/pytorch/pytorch:2.0.0-cuda11.7-cudnn8-runtime

%setup  
    mkdir -p ${APPTAINER_ROOTFS}/.config/Ultralytics/
    mkdir -p ${APPTAINER_ROOTFS}/app/yolov5
    cp -r requirements.txt ${APPTAINER_ROOTFS}/app/
    cp -r ./yolov5/* ${APPTAINER_ROOTFS}/app/yolov5

%post
    export OMP_NUM_THREADS=1
    export DEBIAN_FRONTEND=teletype
    export DEBIAN_FRONTEND=noninteractive

%post
    # Modify /etc/apt/sources.list to use PkgCache
    total_lines=$(wc -l < /etc/apt/sources.list) && lines_to_keep=$((total_lines - 6)) && head -n $lines_to_keep /etc/apt/sources.list > /etc/apt/sources.list.new
    sed -i 's|http://archive.ubuntu.com/ubuntu/|http://192.168.2.25:9081/repository/ubuntu/|g' /etc/apt/sources.list.new
    mv /etc/apt/sources.list.new /etc/apt/sources.list
    
    apt-get update
    TZ=Etc/UTC apt-get install -y tzdata
    apt-get install --no-install-recommends -y gcc git zip curl htop libgl1 libglib2.0-0 libpython3-dev gnupg wget
    apt-get upgrade --no-install-recommends -y openssl

    # Downloads to user config dir
    curl -o ${APPTAINER_ROOTFS}/.config/Ultralytics/Arial.ttf http://192.168.2.25:9081/repository/storage/Arial.ttf
    curl -o ${APPTAINER_ROOTFS}/.config/Ultralytics/Arial.Unicode.ttf http://192.168.2.25:9081/repository/storage/Arial.Unicode.ttf

   
    cd ${APPTAINER_ROOTFS}/app
    curl -o ${APPTAINER_ROOTFS}/app/v2-1_768-ema-pruned.ckpt http://192.168.2.25:9081/repository/storage/v2-1_768-ema-pruned.ckpt
    
    # Modify ~/.pip/pip.conf to use PkgCache
    mkdir ~/.pip/; test -f ~/.pip/pip.conf && mv ~/.pip/pip.conf ~/.pip/pip.conf.bak; curl -s -o ~/.pip/pip.conf -m 3 https://raw.githubusercontent.com/brandnewworld/staging/refs/heads/main/pip.conf

    python3 -m pip install --upgrade pip wheel
    pip3 install --no-cache -r requirements.txt albumentations comet gsutil notebook \
        coremltools onnx onnx-simplifier onnxruntime 'openvino-dev>=2023.0'
        # tensorflow tensorflowjs \

%runscript
    exec python3 yolov5/detect.py --project ./test/runs/detect --weights ./test/yolov5s.pt --source ./test/zidane.jpg