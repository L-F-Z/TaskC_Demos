Bootstrap: docker
From: 192.168.143.41:10081/library/python:3.9-slim-buster

%environment
    export PATH=/usr/local/bin:$PATH
    export PYTHONUNBUFFERED=1

%setup
    mkdir -p ${APPTAINER_ROOTFS}/app/CLIP
    mkdir -p ${APPTAINER_ROOTFS}/.pip/
    cp -r ./CLIP/* ${APPTAINER_ROOTFS}/app/CLIP/
    cp ./resource/pip.conf ${APPTAINER_ROOTFS}/.pip/pip.conf
    # pip config list

%post
    # change apt source
    sed -i '4s/^/#/' /etc/apt/sources.list && \
    sed -i 's|http://deb.debian.org/debian|http://192.168.143.41:9081/repository/debian/|g' /etc/apt/sources.list

    apt-get update && apt-get install -y \
        libgl1-mesa-glx \
        libegl1-mesa \
        libxrandr2 \
        libxss1 \
        libxcursor1 \
        libxcomposite1 \
        libasound2 \
        libxi6 \
        libxtst6 \
        curl \
        && apt-get clean \
        && rm -rf /var/lib/apt/lists/*

    # change pip source
    # mkdir ~/.pip/
    # test -f ~/.pip/pip.conf && \
    # mv ~/.pip/pip.conf ~/.pip/pip.conf.bak && \
    # curl -s -o ~/.pip/pip.conf -m 3 https://raw.githubusercontent.com/brandnewworld/staging/refs/heads/main/pip.conf

    pip install --no-cache-dir \
        torch===2.5.1+cu124 \
        torchvision===0.20.1+cu124 \
        torchaudio===2.5.1+cu124 \
        ftfy \
        regex \
        tqdm \
        --extra-index-url http://192.168.143.41:9081/repository/python/simple/

    cd /app/CLIP
    pip install --no-cache-dir -r requirements.txt
    pip install --no-cache-dir .

%runscript
    exec /bin/bash "$@"